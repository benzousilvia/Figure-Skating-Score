<!DOCTYPE html>
<html lang="ja" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Figure Skating Score — 新UIプロトタイプ</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --brand: #0d6efd;
    }
    body{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans JP', sans-serif; }
    .navbar-brand{ font-weight: 700; letter-spacing: 0.3px; }
    .page{ padding: 16px 16px 64px; }
    .card{ border-radius: 12px; }
    .goe-scale{ font-size:12px; display:flex; justify-content:space-between; color:#6c757d }
    .sticky-col{ position: sticky; top: 12px; }
    .table thead th{ position: sticky; top:0; background:var(--bs-body-bg); z-index:1; }
    .handle{ cursor:grab; color:#adb5bd; }
    .elem-preview{ min-height: 40px; border:1px dashed #dee2e6; border-radius: 8px; padding: .5rem .75rem; font-size:1.1rem; }
    .score-pill{ font-variant-numeric: tabular-nums; }
    .nav-pills .nav-link{ border-radius:999px; }
    .btn-check + .btn{ border-radius: 999px; }
    .section-title{ font-weight:600; font-size:1rem; color:#6c757d; }
    /* 極小端末の詰め */
    @media (max-width: 360px){ .btn-sm{ padding:.25rem .45rem; font-size:.8rem; } }
  </style>
  <script>
    // 簡易モック: プレビュー更新のみ（実計算は既存script.jsに委ね）
    document.addEventListener('DOMContentLoaded', () => {
      const preview = document.getElementById('elemPreview');
      // GOEはラジオボタン形式に変更
      // PCS スライダーと表示バッジ
      const pcsCo = document.getElementById('pcs-co');
      const pcsCoVal = document.getElementById('pcs-co-val');
      const pcsPr = document.getElementById('pcs-pr');
      const pcsPrVal = document.getElementById('pcs-pr-val');
      const pcsSs = document.getElementById('pcs-ss');
      const pcsSsVal = document.getElementById('pcs-ss-val');

      function updatePreview(){
        const active = document.querySelector('.tab-pane.active')?.id;
        if (active === 'pane-jmp') {
          const rot = document.querySelector('input[name="rot"]:checked')?.value || '0';
          const type = document.querySelector('input[name="type"]:checked')?.value || '';
          preview.textContent = ((rot !== '0' ? rot : '') + type) || '要素';
          return;
        }

        if (active === 'pane-spin') {
          const sp = document.querySelector('input[name="sp"]:checked');
          const spType = sp ? document.querySelector(`label[for="${sp.id}"]`)?.textContent || '' : '';
          const f = document.getElementById('spF').checked;
          const c = document.getElementById('spC').checked;
          const v = document.getElementById('spV').checked;
          const inv = document.getElementById('spINV').checked;
          const levRadio = document.querySelector('input[name="lev"]:checked');
          const lev = levRadio ? document.querySelector(`label[for="${levRadio.id}"]`)?.textContent || '' : '';
          const txt = `${f?'F':''}${c?'C':''}${spType}${v?'V':''}${lev}${inv?'*':''}`;
          preview.textContent = txt || '要素';
          return;
        }

        if (active === 'pane-seq') {
          const sq = document.querySelector('input[name="sq"]:checked');
          const sqType = sq ? document.querySelector(`label[for="${sq.id}"]`)?.textContent || '' : '';
          const levRadio = document.querySelector('input[name="sqlev"]:checked');
          const lev = levRadio ? document.querySelector(`label[for="${levRadio.id}"]`)?.textContent || '' : '';
          const inv = document.getElementById('sqINV').checked;
          const txt = `${sqType}${lev}${inv?'*':''}`;
          preview.textContent = txt || '要素';
          return;
        }

        preview.textContent = '要素';
      }

      // GOEプレビュー表示は削除済み

      // PCS数値の初期表示と更新
      const setBadge = (el, badge) => { if (el && badge) badge.textContent = Number(el.value).toFixed(2); };
      setBadge(pcsCo, pcsCoVal);
      setBadge(pcsPr, pcsPrVal);
      setBadge(pcsSs, pcsSsVal);
      [
        [pcsCo, pcsCoVal],
        [pcsPr, pcsPrVal],
        [pcsSs, pcsSsVal]
      ].forEach(([el, badge]) => {
        if (!el || !badge) return;
        el.addEventListener('input', () => setBadge(el, badge));
      });

      document.querySelectorAll('#pane-jmp input, #pane-spin input, #pane-seq input').forEach(el => {
        el.addEventListener('input', updatePreview);
        el.addEventListener('change', updatePreview);
      });

      updatePreview();
    });
  </script>
  <!-- 既存アプリ接続時は、script.js/basevalues.jsへ差し替え可 -->
</head>
<body>
  <!-- ヘッダ/ナビ -->
  <nav class="navbar navbar-expand-md bg-body border-bottom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-snow"></i> Figure Skating Score</a>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#help" aria-controls="help">
          <i class="bi bi-question-circle"></i> ヘルプ
        </button>
      </div>
    </div>
  </nav>

  <main class="page container-fluid">
    <div class="row g-3">
      <!-- 左: コンポーザ -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <div class="section-title">要素コンポーザ</div>
            </div>
            <div class="mt-3 elem-preview d-flex align-items-center justify-content-start">
              <div id="elemPreview">要素</div>
            </div>

            <!-- タブ: ジャンプ/スピン/シークエンス -->
            <ul class="nav nav-pills my-3" id="pills-tab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-jmp" data-bs-toggle="pill" data-bs-target="#pane-jmp" type="button" role="tab">ジャンプ</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-spin" data-bs-toggle="pill" data-bs-target="#pane-spin" type="button" role="tab">スピン</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-seq" data-bs-toggle="pill" data-bs-target="#pane-seq" type="button" role="tab">シークエンス</button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- ジャンプ -->
              <div class="tab-pane fade show active" id="pane-jmp" role="tabpanel">
                <div class="row g-3">
                  <div class="col-12">
                    <div class="text-secondary small mb-1">回転数</div>
                    <div class="btn-group" role="group" aria-label="rotations">
                      <!-- 可用回転のみenabled（モック:全て有効） -->
                      <input class="btn-check" type="radio" name="rot" id="rot0" value="0"><label class="btn btn-outline-primary" for="rot0">0</label>
                      <input class="btn-check" type="radio" name="rot" id="rot1" value="1"><label class="btn btn-outline-primary" for="rot1">1</label>
                      <input class="btn-check" type="radio" name="rot" id="rot2" value="2"><label class="btn btn-outline-primary" for="rot2">2</label>
                      <input class="btn-check" type="radio" name="rot" id="rot3" value="3" checked><label class="btn btn-outline-primary" for="rot3">3</label>
                      <input class="btn-check" type="radio" name="rot" id="rot4" value="4"><label class="btn btn-outline-primary" for="rot4">4</label>
                      <input class="btn-check" type="radio" name="rot" id="rot5" value="5"><label class="btn btn-outline-primary" for="rot5">5</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-secondary small mb-1">種類</div>
                    <div class="btn-group" role="group" aria-label="types">
                      <input class="btn-check" type="radio" name="type" id="tA" value="A"><label class="btn btn-outline-primary" for="tA">A</label>
                      <input class="btn-check" type="radio" name="type" id="tT" value="T" checked><label class="btn btn-outline-primary" for="tT">T</label>
                      <input class="btn-check" type="radio" name="type" id="tS" value="S"><label class="btn btn-outline-primary" for="tS">S</label>
                      <input class="btn-check" type="radio" name="type" id="tLo" value="Lo"><label class="btn btn-outline-primary" for="tLo">Lo</label>
                      <input class="btn-check" type="radio" name="type" id="tF" value="F"><label class="btn btn-outline-primary" for="tF">F</label>
                      <input class="btn-check" type="radio" name="type" id="tLz" value="Lz"><label class="btn btn-outline-primary" for="tLz">Lz</label>
                      <input class="btn-check" type="radio" name="type" id="tEu" value="Eu"><label class="btn btn-outline-primary" for="tEu">Eu</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-secondary small mb-1">詳細</div>
                    <div class="d-flex flex-wrap gap-2">
                      <input class="btn-check" id="flagUR" type="checkbox" name="flag" value="UR"><label class="btn btn-outline-secondary btn-sm" for="flagUR">&lt;</label>
                      <input class="btn-check" id="flagDG" type="checkbox" name="flag" value="DG"><label class="btn btn-outline-secondary btn-sm" for="flagDG">&lt;&lt;</label>
                      <input class="btn-check" id="flagATT" type="checkbox" name="flag" value="!"><label class="btn btn-outline-secondary btn-sm" for="flagATT">!</label>
                      <input class="btn-check" id="flagE"  type="checkbox" name="flag" value="e"><label class="btn btn-outline-secondary btn-sm" for="flagE">e</label>
                      <input class="btn-check" id="flagREP" type="checkbox" name="flag" value="REP"><label class="btn btn-outline-secondary btn-sm" for="flagREP">+REP</label>
                      <input class="btn-check" id="flagINV" type="checkbox" name="flag" value="*"><label class="btn btn-outline-secondary btn-sm" for="flagINV">*</label>
                      <input class="btn-check" id="spinV" type="checkbox"><label class="btn btn-outline-secondary btn-sm" for="spinV">V</label>
                      <div class="form-check form-switch ms-2">
                        <input class="form-check-input" type="checkbox" role="switch" id="bonus">
                        <label class="form-check-label" for="bonus">ボーナス(x)</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-secondary small mb-1">GOE</div>
                    <div class="btn-group btn-group-sm" role="group" aria-label="GOE選択">
                      <input type="radio" class="btn-check" name="goe" value="-5" id="goe-5">
                      <label class="btn btn-outline-danger" for="goe-5">-5</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="-4" id="goe-4">
                      <label class="btn btn-outline-danger" for="goe-4">-4</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="-3" id="goe-3">
                      <label class="btn btn-outline-danger" for="goe-3">-3</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="-2" id="goe-2">
                      <label class="btn btn-outline-danger" for="goe-2">-2</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="-1" id="goe-1">
                      <label class="btn btn-outline-danger" for="goe-1">-1</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="0" id="goe0" checked>
                      <label class="btn btn-outline-secondary" for="goe0">0</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="1" id="goe1">
                      <label class="btn btn-outline-success" for="goe1">+1</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="2" id="goe2">
                      <label class="btn btn-outline-success" for="goe2">+2</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="3" id="goe3">
                      <label class="btn btn-outline-success" for="goe3">+3</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="4" id="goe4">
                      <label class="btn btn-outline-success" for="goe4">+4</label>
                      
                      <input type="radio" class="btn-check" name="goe" value="5" id="goe5">
                      <label class="btn btn-outline-success" for="goe5">+5</label>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                  <button class="btn btn-outline-danger" id="btn-clear-entry"><i class="bi bi-eraser"></i> 入力をクリア</button>
                  <div class="btn-group">
                    <button class="btn btn-outline-primary" id="btn-add-jump"><i class="bi bi-plus-lg"></i> ジャンプ追加</button>
                    <button class="btn btn-primary" id="btn-add-element"><i class="bi bi-check2"></i> 要素を追加</button>
                </div>
              </div>
              </div>

              <!-- スピン -->
              <div class="tab-pane fade" id="pane-spin" role="tabpanel">
                <div class="text-secondary small mb-1">スピン種類</div>
                <div class="btn-group mb-2" role="group">
                  <input class="btn-check" type="radio" name="sp" id="spUSp"><label class="btn btn-outline-info" for="spUSp">USp</label>
                  <input class="btn-check" type="radio" name="sp" id="spLSp"><label class="btn btn-outline-info" for="spLSp">LSp</label>
                  <input class="btn-check" type="radio" name="sp" id="spCSp"><label class="btn btn-outline-info" for="spCSp">CSp</label>
                  <input class="btn-check" type="radio" name="sp" id="spSSp"><label class="btn btn-outline-info" for="spSSp">SSp</label>
                  <input class="btn-check" type="radio" name="sp" id="spCoSp"><label class="btn btn-outline-info" for="spCoSp">CoSp</label>
                </div>
                <div class="text-secondary small mb-1">詳細</div>
                <div class="d-flex flex-wrap gap-2 mb-2">
                  <input class="btn-check" id="spF" type="checkbox"><label class="btn btn-outline-secondary btn-sm" for="spF">F</label>
                  <input class="btn-check" id="spC" type="checkbox"><label class="btn btn-outline-secondary btn-sm" for="spC">C</label>
                  <input class="btn-check" id="spV" type="checkbox"><label class="btn btn-outline-secondary btn-sm" for="spV">V</label>
                  <input class="btn-check" id="spINV" type="checkbox"><label class="btn btn-outline-secondary btn-sm" for="spINV">*</label>
                </div>
                <div class="text-secondary small mb-1">レベル</div>
                <div class="btn-group" role="group">
                  <input class="btn-check" type="radio" name="lev" id="lev0"><label class="btn btn-outline-info" for="lev0">0</label>
                  <input class="btn-check" type="radio" name="lev" id="levB"><label class="btn btn-outline-info" for="levB">B</label>
                  <input class="btn-check" type="radio" name="lev" id="lev1"><label class="btn btn-outline-info" for="lev1">1</label>
                  <input class="btn-check" type="radio" name="lev" id="lev2"><label class="btn btn-outline-info" for="lev2">2</label>
                  <input class="btn-check" type="radio" name="lev" id="lev3"><label class="btn btn-outline-info" for="lev3">3</label>
                  <input class="btn-check" type="radio" name="lev" id="lev4"><label class="btn btn-outline-info" for="lev4">4</label>
                </div>
                
                <div class="mt-3">
                  <div class="text-secondary small mb-1">GOE</div>
                  <div class="btn-group btn-group-sm" role="group" aria-label="GOE選択">
                    <input type="radio" class="btn-check" name="goe-spin" value="-5" id="goe-spin-5">
                    <label class="btn btn-outline-danger" for="goe-spin-5">-5</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="-4" id="goe-spin-4">
                    <label class="btn btn-outline-danger" for="goe-spin-4">-4</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="-3" id="goe-spin-3">
                    <label class="btn btn-outline-danger" for="goe-spin-3">-3</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="-2" id="goe-spin-2">
                    <label class="btn btn-outline-danger" for="goe-spin-2">-2</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="-1" id="goe-spin-1">
                    <label class="btn btn-outline-danger" for="goe-spin-1">-1</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="0" id="goe-spin0" checked>
                    <label class="btn btn-outline-secondary" for="goe-spin0">0</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="1" id="goe-spin1">
                    <label class="btn btn-outline-success" for="goe-spin1">+1</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="2" id="goe-spin2">
                    <label class="btn btn-outline-success" for="goe-spin2">+2</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="3" id="goe-spin3">
                    <label class="btn btn-outline-success" for="goe-spin3">+3</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="4" id="goe-spin4">
                    <label class="btn btn-outline-success" for="goe-spin4">+4</label>
                    
                    <input type="radio" class="btn-check" name="goe-spin" value="5" id="goe-spin5">
                    <label class="btn btn-outline-success" for="goe-spin5">+5</label>
                  </div>
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                  <div></div>
                  <div class="btn-group">
                    <button class="btn btn-primary" id="btn-add-spin"><i class="bi bi-check2"></i> 要素を追加</button>
                  </div>
                </div>
              </div>

              <!-- シークエンス -->
              <div class="tab-pane fade" id="pane-seq" role="tabpanel">
                <div class="text-secondary small mb-1">種類</div>
                <div class="btn-group mb-2" role="group">
                  <input class="btn-check" type="radio" name="sq" id="sqStSq"><label class="btn btn-outline-success" for="sqStSq">StSq</label>
                  <input class="btn-check" type="radio" name="sq" id="sqChSq"><label class="btn btn-outline-success" for="sqChSq">ChSq</label>
                </div>
                <div class="text-secondary small mb-1">レベル</div>
                <div class="btn-group" role="group">
                  <input class="btn-check" type="radio" name="sqlev" id="sq0"><label class="btn btn-outline-success" for="sq0">0</label>
                  <input class="btn-check" type="radio" name="sqlev" id="sqB"><label class="btn btn-outline-success" for="sqB">B</label>
                  <input class="btn-check" type="radio" name="sqlev" id="sq1"><label class="btn btn-outline-success" for="sq1">1</label>
                  <input class="btn-check" type="radio" name="sqlev" id="sq2"><label class="btn btn-outline-success" for="sq2">2</label>
                  <input class="btn-check" type="radio" name="sqlev" id="sq3"><label class="btn btn-outline-success" for="sq3">3</label>
                  <input class="btn-check" type="radio" name="sqlev" id="sq4"><label class="btn btn-outline-success" for="sq4">4</label>
                </div>
                <div class="text-secondary small mb-1 mt-2">詳細</div>
                <div class="d-flex flex-wrap gap-2 mb-2">
                  <input class="btn-check" id="sqINV" type="checkbox"><label class="btn btn-outline-secondary btn-sm" for="sqINV">*</label>
                </div>
                
                <div class="mt-3">
                  <div class="text-secondary small mb-1">GOE</div>
                  <div class="btn-group btn-group-sm" role="group" aria-label="GOE選択">
                    <input type="radio" class="btn-check" name="goe-seq" value="-5" id="goe-seq-5">
                    <label class="btn btn-outline-danger" for="goe-seq-5">-5</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="-4" id="goe-seq-4">
                    <label class="btn btn-outline-danger" for="goe-seq-4">-4</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="-3" id="goe-seq-3">
                    <label class="btn btn-outline-danger" for="goe-seq-3">-3</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="-2" id="goe-seq-2">
                    <label class="btn btn-outline-danger" for="goe-seq-2">-2</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="-1" id="goe-seq-1">
                    <label class="btn btn-outline-danger" for="goe-seq-1">-1</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="0" id="goe-seq0" checked>
                    <label class="btn btn-outline-secondary" for="goe-seq0">0</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="1" id="goe-seq1">
                    <label class="btn btn-outline-success" for="goe-seq1">+1</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="2" id="goe-seq2">
                    <label class="btn btn-outline-success" for="goe-seq2">+2</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="3" id="goe-seq3">
                    <label class="btn btn-outline-success" for="goe-seq3">+3</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="4" id="goe-seq4">
                    <label class="btn btn-outline-success" for="goe-seq4">+4</label>
                    
                    <input type="radio" class="btn-check" name="goe-seq" value="5" id="goe-seq5">
                    <label class="btn btn-outline-success" for="goe-seq5">+5</label>
                  </div>
                </div>
                
                <div class="d-flex justify-content-between mt-1">
                  <div></div>
                  <div class="btn-group">
                    <button class="btn btn-primary" id="btn-add-seq"><i class="bi bi-check2"></i> 要素を追加</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PCS -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title">PCS</div>
              <div class="input-group input-group-sm" style="width: 180px;">
                <span class="input-group-text">係数</span>
                <input type="number" class="form-control" id="pcs-factor" value="1.67" step="0.01">
              </div>
            </div>
            <div class="row g-3">
              <div class="col-12 col-sm-4">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label mb-0" for="pcs-co">構成</label>
                  <span class="badge text-bg-secondary" id="pcs-co-val">0.00</span>
                </div>
                <input id="pcs-co" type="range" class="form-range" min="0" max="10" step="0.25" value="0">
              </div>
              <div class="col-12 col-sm-4">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label mb-0" for="pcs-pr">表現</label>
                  <span class="badge text-bg-secondary" id="pcs-pr-val">0.00</span>
                </div>
                <input id="pcs-pr" type="range" class="form-range" min="0" max="10" step="0.25" value="0">
              </div>
              <div class="col-12 col-sm-4">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label mb-0" for="pcs-ss">スケート技術</label>
                  <span class="badge text-bg-secondary" id="pcs-ss-val">0.00</span>
                </div>
                <input id="pcs-ss" type="range" class="form-range" min="0" max="10" step="0.25" value="0">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 右: プログラム/スコア -->
      <div class="col-12 col-lg-6">
        <div class="sticky-col">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div class="section-title">プログラム要素</div>
              </div>
              <div class="table-responsive" style="max-height: 46vh;">
                <table class="table align-middle" id="elements-table">
                  <thead>
                    <tr>
                      <th style="width:36px"></th>
                      <th>#</th>
                      <th>実行要素</th>
                      <th>基礎点</th>
                      <th>GOE</th>
                      <th>GOE値</th>
                      <th>得点</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody class="displayTable">
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <div class="row g-3 align-items-center">
                <div class="col-12 col-sm">
                  <div class="text-secondary small">TES</div>
                  <div class="h3 m-0 score-pill" id="tes">0.00</div>
                </div>
                <div class="col-12 col-sm">
                  <div class="text-secondary small">PCS</div>
                  <div class="h3 m-0 score-pill" id="pcs">0.00</div>
                </div>
                <div class="col-12 col-sm">
                  <div class="text-secondary small">減点</div>
                  <div>
                    <input type="number" class="form-control form-control-sm" id="deduct" value="0" step="0.1">
                  </div>
                </div>
                <div class="col-12 col-sm">
                  <div class="text-secondary small">合計</div>
                  <div class="h2 m-0 score-pill text-primary" id="tss">0.00</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ヘルプ -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="help" aria-labelledby="helpLabel">
    <div class="offcanvas-header">
      <h5 id="helpLabel">操作のヒント</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul>
        <li>ジャンプ種類選択後、利用可能な回転数のみが有効になります。</li>
        <li>GOEはボタンクリックで素早く選択できます。</li>
        <li>要素一覧はドラッグで並べ替えできます。</li>
      </ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initSOV, getAvailableRotationsFor, basevalues } from './basevalues.js';

    const state = {
      buffer: [newPart()],
      elements: [],
      pcs: { co: 0, pr: 0, ss: 0, factor: 1.67 },
      deduct: 0,
      editingIndex: null,
      isComboMode: false,
    };

    function newPart(){
      return { type:null, name:null, lod:'0', ur:false, dg:false, attention:false, edge:false, rep:false, spinV:false, fly:false, cof:false, invalid:false, bonus:false, goe:0 };
    }

    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    function updateRotationButtons(){
      const type = document.querySelector('input[name="type"]:checked')?.value;
      const rotRadios = [0,1,2,3,4,5].map(n=>document.getElementById('rot'+n));
      rotRadios.forEach(r=>{ if(r) r.disabled = true; });
      if (!type){ if(rotRadios[0]) rotRadios[0].disabled=false; return; }
      const avail = getAvailableRotationsFor(type);
      rotRadios.forEach((r,idx)=>{ if(!r) return; if(idx===0 || avail.includes(idx)) r.disabled=false; });
      // 5回転時はA無効
      const rot = document.querySelector('input[name="rot"]:checked')?.value;
      const aBtn = document.getElementById('tA');
      if (aBtn){ aBtn.disabled = (rot==='5'); }
    }

    function currentTab(){
      if (document.getElementById('pane-jmp').classList.contains('active')) return 'jump';
      if (document.getElementById('pane-spin').classList.contains('active')) return 'spin';
      return 'seq';
    }

    function isRenderablePart(p){
      if (!p || !p.type) return false;
      if (p.type === 'jump') return !!p.name; // lodは0以外が望ましいが、表示上はnameがあれば十分
      if (p.type === 'spin') return !!p.name;
      if (p.type === 'seq') return !!p.name;
      return false;
    }

    function buildBufferedParts(){
      const tab = currentTab();
      const parts = deepClone(state.buffer);
      if (tab==='jump'){
        // 選択されたジャンプ種別がなければバッファを変更せず返す
        const selectedType = document.querySelector('input[name="type"]:checked');
        if (!selectedType) return parts;

        // reflect UI to buffer[buffer.length-1]
        const p = parts[parts.length-1];
        p.type = 'jump';
        p.lod = document.querySelector('input[name="rot"]:checked')?.value || '0';
        p.name = selectedType.value;
        p.ur = document.getElementById('flagUR').checked;
        p.dg = document.getElementById('flagDG').checked;
        p.attention = document.getElementById('flagATT').checked;
        p.edge = document.getElementById('flagE').checked;
        p.rep = document.getElementById('flagREP').checked;
        p.invalid = document.getElementById('flagINV').checked;
        parts[0].bonus = document.getElementById('bonus').checked;
        parts[0].goe = parseInt(document.querySelector('input[name="goe"]:checked')?.value)||0;
      } else if (tab==='spin'){
        const p = newPart();
        p.type='spin';
        p.name = ['USp','LSp','CSp','SSp','CoSp'].find(id=>document.getElementById('sp'+id)?.checked) || null;
        const lev = ['0','B','1','2','3','4'].find(id=>document.getElementById('lev'+id)?.checked);
        p.lod = lev || '0';
        p.fly = document.getElementById('spF').checked;
        p.cof = document.getElementById('spC').checked;
        p.spinV = document.getElementById('spV').checked;
        p.invalid = document.getElementById('spINV').checked;
        parts.length = 0; parts.push(p);
        parts[0].goe = parseInt(document.querySelector('input[name="goe-spin"]:checked')?.value)||0;
      } else {
        const p = newPart();
        p.type='seq';
        p.name = (document.getElementById('sqStSq')?.checked? 'StSq' : (document.getElementById('sqChSq')?.checked? 'ChSq': null));
        const lev = ['0','B','1','2','3','4'].find(id=>document.getElementById('sq'+id)?.checked);
        p.lod = lev || '0';
        p.invalid = document.getElementById('sqINV').checked;
        parts.length = 0; parts.push(p);
        parts[0].goe = parseInt(document.querySelector('input[name="goe-seq"]:checked')?.value)||0;
      }
      return parts;
    }

    function getElementDisplayText(parts){
      const seq = parts.filter(isRenderablePart);
      let out = '';
      for (let i=0;i<seq.length;i++){
        const p = seq[i];
        if (p.type==='jump'){
          if (p.lod && p.lod!=='0') out += String(p.lod);
          if (p.name) out += p.name;
          if (p.attention) out += '!';
          if (p.edge) out += 'e';
          if (p.ur) out += '<';
          if (p.dg) out += '<<';
          if (p.invalid) out += '*';
          if (p.rep) out += '+REP';
        } else if (p.type==='spin'){
          if (p.fly) out += 'F';
          if (p.cof) out += 'C';
          if (p.name) out += p.name;
          if (p.lod && p.lod!=='0') out += String(p.lod);
          if (p.spinV) out += 'V';
          if (p.invalid) out += '*';
        } else {
          if (p.name) out += p.name;
          if (p.lod && p.lod!=='0') out += String(p.lod);
          if (p.invalid) out += '*';
        }
        if (i!==seq.length-1) out += '+';
      }
      if (seq.length>0 && parts[0]?.bonus) out += '  x';
      return out;
    }

    function computeElementResult(parts){
      const local = deepClone(parts).filter(isRenderablePart);
      let sumBVForScore = 0.0;
      const bvForGOEList = [];
      for (let i=0;i<local.length;i++){
        const p = local[i];
        if (p.invalid){ p.bv = 0.0; }
        else if (p.type==='jump'){
          const lodInt = parseInt(p.lod||'0',10);
          if (p.dg && lodInt!==0){ p.bv = basevalues[p.name]?.[lodInt-1] ?? 0.0; }
          else { p.bv = basevalues[p.name]?.[p.lod] ?? 0.0; }
        } else if (p.type==='seq'){
          p.bv = basevalues[p.name]?.[p.lod] ?? 0.0;
        } else { // spin
          if (p.cof){ p.bv = basevalues[p.name]?.['C'+p.lod] ?? 0.0; }
          else if (p.fly){ p.bv = basevalues[p.name]?.['F'+p.lod] ?? 0.0; }
          else { p.bv = basevalues[p.name]?.[p.lod] ?? 0.0; }
        }

        p.bvForScoreCalculation = p.bv;
        if (local[0].bonus) p.bvForScoreCalculation *= 1.1;
        if (p.rep) p.bvForScoreCalculation *= 0.7;
        if (p.ur && p.edge) p.bvForScoreCalculation *= 0.6;
        else if (p.spinV) p.bvForScoreCalculation *= 0.75;
        else if (p.ur || p.edge) p.bvForScoreCalculation *= 0.8;
        sumBVForScore += p.bvForScoreCalculation;

        if (p.name!=='ChSq'){
          if (p.ur && p.edge) p.bvForGOECalculation = p.bv * 0.6;
          else if (p.spinV) p.bvForGOECalculation = p.bv * 0.75;
          else if (p.ur || p.edge) p.bvForGOECalculation = p.bv * 0.8;
          else p.bvForGOECalculation = p.bv;
        } else { p.bvForGOECalculation = p.bv; }
        p.bvForGOECalculation = Math.round(p.bvForGOECalculation * 1000 / 10) / 100;
        bvForGOEList.push(p.bvForGOECalculation);
      }
      const goe = parseInt(local[0].goe||0,10);
      let goeValue = 0.0;
      if (local[0].name==='ChSq') goeValue = goe * 0.5;
      else if (goe!==0) goeValue = Math.max(...bvForGOEList,0) * (goe * 0.1);
      goeValue = Math.round(goeValue * 1000 / 10) / 100;

      const totalBV = Math.round(sumBVForScore * 1000 / 10) / 100;
      const totalScore = Math.round((sumBVForScore + goeValue) * 1000 / 10) / 100;
      return { totalBV, goe, goeValue, totalScore };
    }

    function renderPreview(){
      // プレビュー欄はバッファ内の有効なジャンプのみ表示（UI選択は無視）
      const validParts = state.buffer.filter(isRenderablePart);
      
      if (validParts.length === 0) {
        // バッファに有効なジャンプがない場合は空欄
        document.getElementById('elemPreview').textContent = '要素';
      } else {
        // バッファに有効なジャンプがある場合のみ表示（UI選択とは独立）
        let text = getElementDisplayText(validParts);
        document.getElementById('elemPreview').textContent = text || '要素';
      }
      
      // GOE値プレビューは削除済み
    }

    function renderElements(){
      const tbody = document.querySelector('.displayTable');
      tbody.innerHTML = '';
      state.elements.forEach((parts, idx)=>{
        const res = computeElementResult(parts);
        const tr = document.createElement('tr');
        tr.dataset.index = String(idx);
        tr.draggable = true;
        tr.innerHTML = `
          <td class="text-center"><i class="bi bi-grip-vertical handle"></i></td>
          <td>${idx+1}</td>
          <td>${getElementDisplayText(parts)}</td>
          <td>${res.totalBV.toFixed(2)}</td>
          <td>${res.goe>0?('+'+res.goe):res.goe}</td>
          <td>${res.goeValue.toFixed(2)}</td>
          <td class="elemScore">${res.totalScore.toFixed(2)}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-secondary edit"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger delete"><i class="bi bi-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
      attachRowHandlers();
      updateTSS();
    }

    function attachRowHandlers(){
      const tbody = document.querySelector('.displayTable');
      tbody.querySelectorAll('.delete').forEach(btn=> btn.addEventListener('click', (e)=>{
        const idx = parseInt(e.currentTarget.closest('tr').dataset.index,10);
        state.elements.splice(idx,1);
        renderElements();
      }));
      tbody.querySelectorAll('.edit').forEach(btn=> btn.addEventListener('click', (e)=>{
        const idx = parseInt(e.currentTarget.closest('tr').dataset.index,10);
        state.editingIndex = idx;
        const parts = deepClone(state.elements[idx]);
        loadPartsIntoUI(parts);
      }));
      // DnD
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(r=>{
        r.addEventListener('dragstart', (ev)=>{
          ev.dataTransfer.setData('text/plain', ev.currentTarget.dataset.index);
          ev.dataTransfer.effectAllowed='move';
        });
        r.addEventListener('dragover', (ev)=>{ ev.preventDefault(); ev.dataTransfer.dropEffect='move'; });
        r.addEventListener('drop', (ev)=>{
          ev.preventDefault();
          const src = parseInt(ev.dataTransfer.getData('text/plain'),10);
          const dst = parseInt(ev.currentTarget.dataset.index,10);
          if (isNaN(src)||isNaN(dst)||src===dst) return;
          const row = state.elements.splice(src,1)[0];
          state.elements.splice(dst,0,row);
          renderElements();
        });
      });
    }

    function updatePCSBadges(){
      const co = Number(document.getElementById('pcs-co').value||0);
      const pr = Number(document.getElementById('pcs-pr').value||0);
      const ss = Number(document.getElementById('pcs-ss').value||0);
      document.getElementById('pcs-co-val').textContent = co.toFixed(2);
      document.getElementById('pcs-pr-val').textContent = pr.toFixed(2);
      document.getElementById('pcs-ss-val').textContent = ss.toFixed(2);
      state.pcs.co = co; state.pcs.pr = pr; state.pcs.ss = ss;
      state.pcs.factor = Number(document.getElementById('pcs-factor').value||1.67);
      updateTSS();
    }

    function updateTSS(){
      // TES
      let tes = 0;
      state.elements.forEach(parts=>{ tes += computeElementResult(parts).totalScore; });
      tes = Math.round(tes * 1000 / 10) / 100;
      document.getElementById('tes').textContent = tes.toFixed(2);
      // PCS
      let pcsTotal = (state.pcs.co + state.pcs.pr + state.pcs.ss) * state.pcs.factor;
      pcsTotal = Math.round(pcsTotal * 1000 / 10) / 100;
      document.getElementById('pcs').textContent = pcsTotal.toFixed(2);
      // TSS
      const deduct = Number(document.getElementById('deduct').value||0);
      const tss = Math.round((tes + pcsTotal + deduct) * 1000 / 10) / 100;
      document.getElementById('tss').textContent = tss.toFixed(2);
    }

    function addJumpToBuffer(){
      // 現在のUI選択から新しいジャンプパートを作成
      const newJump = newPart();
      newJump.type = 'jump';
      newJump.lod = document.querySelector('input[name="rot"]:checked')?.value || '0';
      newJump.name = document.querySelector('input[name="type"]:checked')?.value || null;
      newJump.ur = document.getElementById('flagUR').checked;
      newJump.dg = document.getElementById('flagDG').checked;
      newJump.attention = document.getElementById('flagATT').checked;
      newJump.edge = document.getElementById('flagE').checked;
      newJump.rep = document.getElementById('flagREP').checked;
      newJump.invalid = document.getElementById('flagINV').checked;
      newJump.bonus = document.getElementById('bonus').checked;
      newJump.goe = parseInt(document.querySelector('input[name="goe"]:checked')?.value)||0;
      
      // 有効なジャンプのみバッファに追加
      if (newJump.name) {
        // プレビュー欄が空の場合（初回）か既存ジャンプがある場合
        const validParts = state.buffer.filter(isRenderablePart);
        if (validParts.length === 0) {
          // 初回: バッファを新しいジャンプで初期化
          state.buffer = [newJump];
        } else {
          // 追加: 既存バッファに新しいジャンプを追加
          state.buffer.push(newJump);
        }
        
        // プレビュー表示を更新
        renderPreview();
        
        // UI入力をリセット（ジャンプ種類の選択をクリア）
        document.querySelectorAll('input[name="type"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="rot"]').forEach(r => r.checked = false);
        document.getElementById('rot3').checked = true; // デフォルトの3回転に戻す
        document.querySelectorAll('input[name="flag"]').forEach(r => r.checked = false);
        updateRotationButtons();
      }
    }

    function clearEntry(){ 
      state.buffer = [newPart()];
      state.isComboMode = false;  // 連続ジャンプモード解除
      // プレビュー欄を空欄に設定
      document.getElementById('elemPreview').textContent = '要素';
      // GOE値プレビューは削除済み
    }

    function finalizeElementFromCurrentTab(){
      // 現在のタブ状態から要素パーツを構築（ジャンプ/スピン/シーケンス対応）
      const parts = buildBufferedParts();

      // パーツが有効か検証
      if (!parts[0] || !isRenderablePart(parts[0])) return;

      // 編集中なら差し替え、そうでなければ追加
      if (state.editingIndex != null) {
        state.elements[state.editingIndex] = parts;
        state.editingIndex = null;
      } else {
        state.elements.push(parts);
      }

      renderElements();
      clearEntry();
    }

    function activateTab(tab){
      const map = { jump: 'tab-jmp', spin: 'tab-spin', seq: 'tab-seq' };
      const btnId = map[tab];
      if (btnId){ document.getElementById(btnId).click(); }
    }

    function loadPartsIntoUI(parts){
      if (!parts || parts.length === 0) return;

      // 編集時はisComboModeをリセット（renderPreview関数内で自動判定）
      state.isComboMode = false;

      const first = parts[0];
      if (first.type==='jump'){
        activateTab('jump');
        // バッファそのものを反映
        state.buffer = deepClone(parts);
        const last = state.buffer[state.buffer.length-1];
        // UIを最後のパートでセット
        if (last.lod) { const r = document.getElementById('rot'+last.lod); if (r) r.checked = true; }
        if (last.name) { const id = 't'+last.name; const t = document.getElementById(id); if (t) t.checked = true; }
        document.getElementById('flagUR').checked = !!last.ur;
        document.getElementById('flagDG').checked = !!last.dg;
        document.getElementById('flagATT').checked = !!last.attention;
        document.getElementById('flagE').checked = !!last.edge;
        document.getElementById('flagREP').checked = !!last.rep;
        document.getElementById('flagINV').checked = !!last.invalid;
        document.getElementById('bonus').checked = !!first.bonus;
        const goeRadio = document.querySelector(`input[name="goe"][value="${first.goe || 0}"]`);
        if (goeRadio) goeRadio.checked = true;
        updateRotationButtons();
        
        // 編集時のプレビュー表示（連続ジャンプの場合のみ）
        const validBufferParts = state.buffer.filter(isRenderablePart);
        if (validBufferParts.length > 1) {
          renderPreview();
        } else {
          // 単独ジャンプ編集時はプレビュー欄を空に
          document.getElementById('elemPreview').textContent = '要素';
        }
      } else if (first.type==='spin'){
        // スピン・シーケンスは連続なし
        state.isComboMode = false;
        activateTab('spin');
        state.buffer = deepClone(parts);
        const p = first;
        const spId = 'sp'+p.name; const sp = document.getElementById(spId); if (sp) sp.checked = true;
        const lev = document.getElementById('lev'+p.lod); if (lev) lev.checked = true;
        document.getElementById('spF').checked = !!p.fly;
        document.getElementById('spC').checked = !!p.cof;
        document.getElementById('spV').checked = !!p.spinV;
        document.getElementById('spINV').checked = !!p.invalid;
        const goeRadio = document.querySelector(`input[name="goe-spin"][value="${p.goe || 0}"]`);
        if (goeRadio) goeRadio.checked = true;
        // プレビューなし（スピンは元々プレビュー機能が限定的）
      } else if (first.type==='seq'){
        state.isComboMode = false;
        activateTab('seq');
        state.buffer = deepClone(parts);
        if (first.name==='StSq') document.getElementById('sqStSq').checked = true;
        else document.getElementById('sqChSq').checked = true;
        const lev = document.getElementById('sq'+first.lod); if (lev) lev.checked = true;
        document.getElementById('sqINV').checked = !!first.invalid;
        const goeRadio = document.querySelector(`input[name="goe-seq"][value="${first.goe || 0}"]`);
        if (goeRadio) goeRadio.checked = true;
        // プレビューなし
      }
    }

    // wire events
    (async function(){
      await initSOV();
      // rotation availability
      document.querySelectorAll('input[name="type"]').forEach(r=> r.addEventListener('change', updateRotationButtons));
      document.querySelectorAll('input[name="rot"]').forEach(r=> r.addEventListener('change', updateRotationButtons));
      // GOEプレビュー表示のイベントリスナーは削除済み

      // スピンとシーケンスはプレビュー機能を使用しない

      document.getElementById('btn-add-jump').addEventListener('click', addJumpToBuffer);
      document.getElementById('btn-clear-entry').addEventListener('click', clearEntry);
      document.getElementById('btn-add-element').addEventListener('click', finalizeElementFromCurrentTab);
      document.getElementById('btn-add-spin').addEventListener('click', finalizeElementFromCurrentTab);
      document.getElementById('btn-add-seq').addEventListener('click', finalizeElementFromCurrentTab);

      document.getElementById('pcs-co').addEventListener('input', updatePCSBadges);
      document.getElementById('pcs-pr').addEventListener('input', updatePCSBadges);
      document.getElementById('pcs-ss').addEventListener('input', updatePCSBadges);
      document.getElementById('pcs-factor').addEventListener('input', updatePCSBadges);
      document.getElementById('deduct').addEventListener('input', updateTSS);

      updateRotationButtons();
      // 初期状態はプレビュー欄を空欄に設定
      document.getElementById('elemPreview').textContent = '要素';
      // GOEプレビュー表示は削除済み
      updatePCSBadges();
    })();
  </script>
</body>
<!-- このHTMLはメインUIです（ui_prototypeから移行）。 -->
</html>
